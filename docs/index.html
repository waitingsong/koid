<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>koid</title>
	<meta name="description" content="Documentation for koid">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="assets/js/search.json" data-base=".">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="index.html" class="title">koid</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="globals.html">Globals</a>
				</li>
			</ul>
			<h1>koid</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<a href="#koid" id="koid" style="color: inherit; text-decoration: none;">
					<h1>Koid</h1>
				</a>
				<p>Koid generator yields k-ordered, conflict-free ids in a distributed environment,
				based on <a href="https://github.com/T-PWK/flake-idgen">flake-idgen</a></p>
				<p><a href=""><img src="https://img.shields.io/github/tag/waitingsong/koid.svg" alt="GitHub tag"></a>
					<a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/license-MIT-blue.svg" alt="License"></a>
					<a href=""><img src="https://img.shields.io/badge/lang-TypeScript-blue.svg" alt=""></a>
					<a href="https://github.com/waitingsong/koid/actions?query=workflow%3A%22ci%22"><img src="https://github.com/waitingsong/koid/workflows/ci/badge.svg" alt="ci"></a>
					<a href="https://codecov.io/gh/waitingsong/koid"><img src="https://codecov.io/gh/waitingsong/koid/branch/master/graph/badge.svg?token=xaYSfbo3Xw" alt="codecov"></a>
					<a href="https://conventionalcommits.org"><img src="https://img.shields.io/badge/Conventional%20Commits-1.0.0-yellow.svg" alt="Conventional Commits"></a>
				<a href="https://lernajs.io/"><img src="https://img.shields.io/badge/maintained%20with-lerna-cc00ff.svg" alt="lerna"></a></p>
				<a href="#install" id="install" style="color: inherit; text-decoration: none;">
					<h2>Install</h2>
				</a>
				<pre><code class="language-sh">npm i koid</code></pre>
				<a href="#koid-numbers-format" id="koid-numbers-format" style="color: inherit; text-decoration: none;">
					<h2>Koid Numbers Format</h2>
				</a>
				<p>The Koid is made up of: <code>timestamp</code>, <code>dataCenter</code>, <code>worker</code> and <code>counter</code>. Examples in the following table: </p>
				<table>
					<thead>
						<tr>
							<th>Timestamp</th>
							<th>Datacenter</th>
							<th>Worker</th>
							<th>Counter</th>
							<th>Koid</th>
						</tr>
					</thead>
					<tbody><tr>
							<td>0x8c20543b0</td>
							<td>0b00000</td>
							<td>0b00000</td>
							<td>0x000</td>
							<td>0x02308150ec000000</td>
						</tr>
						<tr>
							<td>0x8c20543b1</td>
							<td>0b00000</td>
							<td>0b00000</td>
							<td>0x000</td>
							<td>0x02308150ec400000</td>
						</tr>
						<tr>
							<td>0x8c20543b1</td>
							<td>0b00000</td>
							<td>0b00000</td>
							<td>0x001</td>
							<td>0x02308150ec400001</td>
						</tr>
						<tr>
							<td>0x8c20543b1</td>
							<td>0b00000</td>
							<td>0b00000</td>
							<td>0x002</td>
							<td>0x02308150ec400002</td>
						</tr>
						<tr>
							<td>0x8c20543b1</td>
							<td>0b00000</td>
							<td>0b00000</td>
							<td>0x003</td>
							<td>0x02308150ec400003</td>
						</tr>
						<tr>
							<td>0x8c20c0335</td>
							<td>0b00011</td>
							<td>0b00001</td>
							<td>0x000</td>
							<td>0x02308300cd461000</td>
						</tr>
						<tr>
							<td>0x8c20c0335</td>
							<td>0b00011</td>
							<td>0b00001</td>
							<td>0x001</td>
							<td>0x02308300cd461001</td>
						</tr>
				</tbody></table>
				<p>As you can see, each Koid is 64 bits long, consisting of:</p>
				<ul>
					<li><code>timestamp</code>, a 42 bit long number of milliseconds elapsed since 1 January 1970 00:00:00 UTC </li>
					<li><code>dataCenter</code>, a 5 bit long datacenter identifier. It can take up to 32 unique values (including 0)</li>
					<li><code>worker</code>, a 5 bit long worker identifier. It can take up to 32 unique values (including 0)</li>
					<li><code>counter</code>, a 12 bit long counter of ids in the same millisecond. It can take up to 4096 unique values. </li>
				</ul>
				<p>Breakdown of bits for an id e.g. <code>5828128208445124608</code> (counter is <code>0</code>, dataCenter is <code>7</code> and worker <code>3</code>) is as follows:</p>
				<pre><code> 010100001110000110101011101110100001000111 00111 00011 000000000000
                                                       |<span class="hljs-string"> ------------ </span>|<span class="hljs-string"> 12 bit counter </span>|
                                                       |<span class="hljs-string"> ------------ </span>|<span class="hljs-string">5 bit worker
                                           </span>|<span class="hljs-string">-----</span>|<span class="hljs-string">                     5 bit datacenter
                                           </span>|<span class="hljs-string"> ----- ----- </span>|<span class="hljs-string"> 10 bit generator identifier </span>|
                                           |<span class="hljs-string"> ----------- </span>|<span class="hljs-string">42 bit timestamp</span></code></pre>
				<a href="#usage" id="usage" style="color: inherit; text-decoration: none;">
					<h2>Usage</h2>
				</a>
				<p>Koid Generator returns 8 byte long node <a href="http://nodejs.org/api/buffer.html">Buffer</a> objects with its bytes representing 64 bit long id. Note that the number is stored in Big Endian format i.e. the most significant byte of the number is stored in the smallest address given and the least significant byte is stored in the largest.</p>
				<p>Koid generator instance has one getter <code>next</code> returning generated id.</p>
				<pre><code class="language-ts"><span class="hljs-keyword">import</span> { KoidFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;koid&#x27;</span>

<span class="hljs-keyword">const</span> koid = KoidFactory()

<span class="hljs-built_in">console</span>.log(koid.next)
<span class="hljs-built_in">console</span>.log(koid.next)
<span class="hljs-built_in">console</span>.log(koid.next)</code></pre>
				<p>It would give something like:</p>
				<pre><code>&lt;Buffer<span class="hljs-number"> 50 </span>dd d5<span class="hljs-number"> 99 </span>01 c0<span class="hljs-number"> 00 </span>00&gt;
&lt;Buffer<span class="hljs-number"> 50 </span>dd d5<span class="hljs-number"> 99 </span>02<span class="hljs-number"> 80 </span>00 00&gt;
&lt;Buffer<span class="hljs-number"> 50 </span>dd d5<span class="hljs-number"> 99 </span>02<span class="hljs-number"> 80 </span>00 01&gt;</code></pre>
				<a href="#counter-overflow" id="counter-overflow" style="color: inherit; text-decoration: none;">
					<h3>Counter overflow</h3>
				</a>
				<p>Koid generator can generate up to 4096 unique identifiers within a millisecond. When generator tries to generate more than 4096 identifiers within a millisecond, <strong>an error is thrown</strong>.</p>
				<a href="#additional-generator-setup-parameters" id="additional-generator-setup-parameters" style="color: inherit; text-decoration: none;">
					<h3>Additional generator setup parameters</h3>
				</a>
				<p>Koid generator constructor takes optional parameter (generator configuration options) with the following properties:</p>
				<ul>
					<li><code>dataCenter</code> (5 bit) - datacenter identifier. It can have values from 0 to 31.</li>
					<li><code>worker</code> (5 bit) - worker identifier. It can have values from 0 to 31.</li>
					<li><code>id</code> (10 bit) - generator identifier. It can have values from 0 to 1023. It can be provided instead of <code>dataCenter</code> and <code>worker</code> identifiers.</li>
					<li><code>epoch</code> - number used to reduce value of a generated timestamp. Note that this number should not exceed number of milliseconds elapsed since 1 January 1970 00:00:00 UTC. It can be used to generate <em>smaller</em> ids.</li>
				</ul>
				<p>Example of using <code>dataCenter</code> and <code>worker</code> identifiers:</p>
				<pre><code class="language-ts"><span class="hljs-keyword">import</span> { KoidFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;koid&#x27;</span>

<span class="hljs-keyword">const</span> koid = KoidFactory()
<span class="hljs-keyword">const</span> koid2 = KoidFactory({ <span class="hljs-attr">dataCenter</span>: <span class="hljs-number">9</span>, <span class="hljs-attr">worker</span>: <span class="hljs-number">7</span> })

<span class="hljs-built_in">console</span>.info(koid.next);
<span class="hljs-built_in">console</span>.info(koid2.next);</code></pre>
				<p>It would give something like:</p>
				<pre><code>&lt;Buffer<span class="hljs-number"> 50 </span>dd da 8f<span class="hljs-number"> 43 </span>40<span class="hljs-number"> 00 </span>00&gt;
&lt;Buffer<span class="hljs-number"> 50 </span>dd da 8f<span class="hljs-number"> 43 </span>d2<span class="hljs-number"> 70 </span>00&gt;</code></pre>
				<a href="#properties" id="properties" style="color: inherit; text-decoration: none;">
					<h3>Properties</h3>
				</a>
				<p>Koid generator has config getter that can be read from a generator instance:</p>
				<ul>
					<li><code>dataCenter</code> - returns worker number used for generator creation</li>
					<li><code>worker</code> - returns worker number used for generator creation</li>
				</ul>
				<pre><code class="language-ts"><span class="hljs-keyword">import</span> { KoidFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;koid&#x27;</span>

<span class="hljs-keyword">const</span> koid = KoidFactory({ <span class="hljs-attr">id</span>: <span class="hljs-number">34</span> })

<span class="hljs-built_in">console</span>.info(koid.dataCenter);   <span class="hljs-comment">// 1</span>
<span class="hljs-built_in">console</span>.info(koid.worker);       <span class="hljs-comment">// 2</span></code></pre>
				<a href="#clock-moving-backward" id="clock-moving-backward" style="color: inherit; text-decoration: none;">
					<h3>Clock moving backward</h3>
				</a>
				<p>From time to time Node.js clock may move backward.
					In most cases it is only a few millisecond.
					However, as the generator relies on current timestamp,
					it won&#39;t be able to generate conflict-free identifiers (i.e. without duplicates) until the clock catches up with the last timestamp value.
				In case of clock move backward an error is thrown.</p>
				<a href="#formatting" id="formatting" style="color: inherit; text-decoration: none;">
					<h3>Formatting</h3>
				</a>
				<p>Koid generator returns Node.js Buffer representing 64-bit number for the sake of future extensions or returned buffer modifications. Node Buffer can also be very easily converted to string format </p>
				<pre><code class="language-ts"><span class="hljs-keyword">import</span> { KoidFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;koid&#x27;</span>

<span class="hljs-keyword">const</span> koid = KoidFactory()

<span class="hljs-keyword">const</span> buf: Buffer = koid.next
<span class="hljs-keyword">const</span> id = buf.readBigInt64BE()
<span class="hljs-keyword">const</span> hexId = buf.toString(<span class="hljs-string">&#x27;hex&#x27;</span>)
</code></pre>
				<p>It would give something like:</p>
				<pre><code class="language-ts">&lt;Buffer 5d c2 cd d1 f4 fd <span class="hljs-number">30</span> <span class="hljs-number">00</span>&gt;
<span class="hljs-number">6756188692651257856n</span> <span class="hljs-comment">// bigint</span>
5dc2cdd1f4fd3000 <span class="hljs-comment">// hex string</span></code></pre>
				<br>
				<a href="#initialization" id="initialization" style="color: inherit; text-decoration: none;">
					<h2>Initialization</h2>
				</a>
				<pre><code class="language-sh">npm run repo:init</code></pre>
				<a href="#update" id="update" style="color: inherit; text-decoration: none;">
					<h2>Update</h2>
				</a>
				<pre><code class="language-sh">npm run bootstrap</code></pre>
				<a href="#test" id="test" style="color: inherit; text-decoration: none;">
					<h2>Test</h2>
				</a>
				<ul>
					<li>Use <code>npm run lint</code> to check code style.</li>
					<li>Use <code>npm run test</code> to run unit test.</li>
				</ul>
				<a href="#note" id="note" style="color: inherit; text-decoration: none;">
					<h2>Note</h2>
				</a>
				<ul>
					<li>Run <code>npm run clean</code> before <code>npm run build</code>, if any file under typescript outDir folder was deleted manually.</li>
					<li>Default publish registry is <code>NPM</code>, configurated in file <code>lerna.json</code></li>
				</ul>
				<a href="#packages" id="packages" style="color: inherit; text-decoration: none;">
					<h2>Packages</h2>
				</a>
				<table>
					<thead>
						<tr>
							<th>Package</th>
							<th>Version</th>
							<th>Dependencies</th>
							<th>DevDependencies</th>
						</tr>
					</thead>
					<tbody><tr>
							<td><a href="https://github.com/waitingsong/koid/tree/master/packages/koid"><code>koid</code></a></td>
							<td><a href="https://github.com/waitingsong/koid/tree/master/packages/koid/CHANGELOG.md"><img src="https://img.shields.io/npm/v/koid.svg?maxAge=86400" alt="main-svg"></a></td>
							<td><a href="https://david-dm.org/waitingsong/koid.svg?path=packages/koid"><img src="https://david-dm.org/waitingsong/koid.svg?path=packages/koid" alt="main-d-svg"></a></td>
							<td><a href="https://david-dm.org/waitingsong/koid?path=packages/koid#info=devDependencies"><img src="https://david-dm.org/waitingsong/koid/dev-status.svg?path=packages/koid" alt="main-dd-svg"></a></td>
						</tr>
						<tr>
							<td><a href="https://github.com/waitingsong/koid/tree/master/packages/egg-koid"><code>egg-koid</code></a></td>
							<td><a href="https://github.com/waitingsong/koid/tree/master/packages/egg-koid/CHANGELOG.md"><img src="https://img.shields.io/npm/v/egg-koid.svg?cacheSeconds=86400" alt="egg-svg"></a></td>
							<td><a href="https://david-dm.org/waitingsong/koid.svg?path=packages/egg-koid"><img src="https://david-dm.org/waitingsong/koid.svg?path=packages/egg-koid" alt="egg-d-svg"></a></td>
							<td><a href="https://david-dm.org/waitingsong/koid?path=packages/egg-koid#info=devDependencies"><img src="https://david-dm.org/waitingsong/koid/dev-status.svg?path=packages/egg-koid" alt="egg-dd-svg"></a></td>
						</tr>
				</tbody></table>
				<a href="#license" id="license" style="color: inherit; text-decoration: none;">
					<h2>License</h2>
				</a>
				<p><a href="LICENSE">MIT</a></p>
				<a href="#languages" id="languages" style="color: inherit; text-decoration: none;">
					<h3>Languages</h3>
				</a>
				<ul>
					<li><a href="README.md">English</a></li>
					<li><a href="README.zh-CN.md">中文</a></li>
				</ul>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="globals  ">
						<a href="globals.html"><em>Globals</em></a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_egg_koid_src_lib_index_.html">&quot;egg-<wbr>koid/src/lib/index&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_koid_src_lib_index_.html">&quot;koid/src/lib/index&quot;</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="assets/js/main.js"></script>
</body>
</html>